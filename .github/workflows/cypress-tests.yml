name: ðŸš€ Cypress E2E Tests Pipeline

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Select test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - saucedemo
          - realworld
          - api
      browser:
        description: 'Browser to use'
        required: false
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - edge
          - electron

env:
  NODE_VERSION: '18'
  CYPRESS_CACHE_FOLDER: ~/.cache/cypress

jobs:
  # Job 1: Setup and prepare
  setup:
    name: ðŸ“¦ Setup & Install Dependencies
    runs-on: ubuntu-latest
    outputs:
      cypress-version: ${{ steps.cypress-version.outputs.version }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“š Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('package.json') }}
          restore-keys: |
            cypress-${{ runner.os }}-

      - name: ðŸ”¨ Install dependencies
        run: npm install

      - name: ðŸ“Š Get Cypress version
        id: cypress-version
        run: echo "version=$(npm list cypress --depth=0 | grep cypress@ | sed 's/.*@//')" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package.json') }}

  # Job 2: Run All Tests (505 tests)
  all-tests:
    name: ðŸ§ª All E2E Tests (505 tests)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“š Restore Cypress cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('package.json') }}

      - name: ðŸ“¦ Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('package.json') }}

      - name: ðŸ§ª Run All Tests (SauceDemo + RealWorld + API)
        uses: cypress-io/github-action@v6
        continue-on-error: true
        with:
          install: false
          spec: |
            cypress/e2e/*.js
            cypress/e2e/realworld/*.js
            cypress/e2e/api/*.js
          browser: ${{ github.event.inputs.browser || 'chrome' }}
          record: false
        env:
          CYPRESS_BASE_URL: https://www.saucedemo.com

      - name: ðŸ“¸ Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-test-screenshots
          path: cypress/screenshots
          if-no-files-found: ignore
          retention-days: 7

      - name: ðŸŽ¥ Upload Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-test-videos
          path: cypress/videos
          if-no-files-found: ignore
          retention-days: 7

      - name: ðŸ“Š Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-test-reports
          path: cypress/reports
          if-no-files-found: ignore
          retention-days: 30

  # Job 3: Generate Consolidated Report
  generate-report:
    name: ðŸ“ˆ Generate Test Report
    runs-on: ubuntu-latest
    needs: [all-tests]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install report dependencies
        run: npm install -g mochawesome-merge mochawesome-report-generator

      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ðŸ“Š Merge Mochawesome reports
        run: |
          mkdir -p consolidated-reports
          find ./artifacts -name '*.json' -type f -exec cp {} consolidated-reports/ \;
          npx mochawesome-merge "consolidated-reports/*.json" > consolidated-reports/merged-report.json || echo "No reports to merge"
        continue-on-error: true

      - name: ðŸŽ¨ Generate HTML report
        run: |
          if [ -f "consolidated-reports/merged-report.json" ]; then
            npx mochawesome-report-generator consolidated-reports/merged-report.json \
              --reportDir consolidated-reports/html \
              --reportTitle "E2E Test Results - Cypress" \
              --reportPageTitle "Test Report" \
              --inline
          fi
        continue-on-error: true

      - name: ðŸ“Š Create Test Summary
        run: |
          echo "# ðŸ§ª E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Test Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cypress Version:** ${{ needs.setup.outputs.cypress-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version:** ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª All Tests (505) | ${{ needs.all-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots (on failures)" >> $GITHUB_STEP_SUMMARY
          echo "- Test execution videos" >> $GITHUB_STEP_SUMMARY
          echo "- HTML test reports" >> $GITHUB_STEP_SUMMARY
          echo "- Raw test data (JSON)" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload Consolidated Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ðŸ“Š-consolidated-test-report
          path: |
            consolidated-reports/html
            consolidated-reports/merged-report.json
          retention-days: 30

      - name: ðŸŽ‰ Upload All Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ðŸ“¸-all-screenshots
          path: ./artifacts/*screenshots*
          if-no-files-found: ignore
          retention-days: 7

      - name: ðŸŽ¬ Upload All Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ðŸŽ¥-all-videos
          path: ./artifacts/*videos*
          if-no-files-found: ignore
          retention-days: 7

  # Job 4: Performance Metrics
  performance-metrics:
    name: âš¡ Performance Metrics
    runs-on: ubuntu-latest
    needs: [all-tests]
    if: always()
    steps:
      - name: ðŸ“Š Calculate Metrics
        run: |
          echo "# âš¡ Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ Execution Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Test Suites:** 3" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Tests:** ~505 tests" >> $GITHUB_STEP_SUMMARY
          echo "- **Parallel Containers:** 3 (SauceDemo)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Test Distribution" >> $GITHUB_STEP_SUMMARY
          echo "- SauceDemo UI Tests: ~300 tests" >> $GITHUB_STEP_SUMMARY
          echo "- RealWorld UI Tests: ~105 tests" >> $GITHUB_STEP_SUMMARY
          echo "- API Tests: ~100 tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ’¡ Optimization Tips" >> $GITHUB_STEP_SUMMARY
          echo "- Consider migrating to Playwright for 60% faster execution" >> $GITHUB_STEP_SUMMARY
          echo "- Current estimated runtime: ~45 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- Potential with Playwright: ~18 minutes" >> $GITHUB_STEP_SUMMARY

  # Job 5: Notify on completion
  notify:
    name: ðŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [all-tests, generate-report]
    if: always()
    steps:
      - name: ðŸ“¢ Create Status Badge
        run: |
          if [ "${{ needs.all-tests.result }}" == "success" ]; then
            echo "STATUS=âœ… All Tests Passed" >> $GITHUB_ENV
            echo "COLOR=green" >> $GITHUB_ENV
          else
            echo "STATUS=âš ï¸ Some Tests Failed" >> $GITHUB_ENV
            echo "COLOR=red" >> $GITHUB_ENV
          fi

      - name: ðŸ“‹ Final Summary
        run: |
          echo "# ðŸŽ¯ Pipeline Completion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Status: ${{ env.STATUS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Available Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ“Š Consolidated HTML Test Report" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ“¸ Test Failure Screenshots" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸŽ¥ Test Execution Videos" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ“ Raw Test Data (JSON)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions on $(date)*" >> $GITHUB_STEP_SUMMARY
